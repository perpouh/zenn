---
title: "Redis + Lambda(Python) + Docker Composeã§å®Ÿç¾ã™ã‚‹æ—¥æ¬¡ãƒãƒƒãƒå‡¦ç†ã‚·ã‚¹ãƒ†ãƒ "
emoji: "ğŸ„"
type: "tech"
topics: ["redis", "python", "lambda", "docker", "postgresql"]
published: false
---

# Redis + Lambda(Python) + Docker Composeã§å®Ÿç¾ã™ã‚‹æ—¥æ¬¡ãƒãƒƒãƒå‡¦ç†ã‚·ã‚¹ãƒ†ãƒ 

---

## ğŸš€ èƒŒæ™¯ãƒ»ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³

SAAï¼ˆAWSèªå®šã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆã‚¢ã‚½ã‚·ã‚¨ã‚¤ãƒˆï¼‰ã‚’å‹‰å¼·ã—ã¦ã„ã‚‹ä¸­ã§ã€ã€Œè‡ªåˆ†ã§AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’çµ„ã¿åˆã‚ã›ã¦ä½•ã‹ä½œã£ã¦ã¿ãŸã„ã€ã¨æ€ã„ã€å®Ÿéš›ã«æ‰‹ã‚’å‹•ã‹ã—ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

é¡Œæã¨ã—ã¦é¸ã‚“ã ã®ã¯ã€åºƒå‘Šã‚·ã‚¹ãƒ†ãƒ ã®ã‚¯ãƒªãƒƒã‚¯ãƒ­ã‚°é›†è¨ˆã§ã™ã€‚  
ã€ŒRedisã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã§ã‚¯ãƒªãƒƒã‚¯æ•°ã‚’è¨˜éŒ²ã—ã€æ—¥æ¬¡ã§Lambdaï¼ˆPythonï¼‰ãƒãƒƒãƒã‚’å‹•ã‹ã—ã¦CTRï¼ˆã‚¯ãƒªãƒƒã‚¯ç‡ï¼‰ã‚’è¨ˆæ¸¬ãƒ»é›†è¨ˆã™ã‚‹ã€ã¨ã„ã†ä»•çµ„ã¿ã‚’æ§‹ç¯‰ã—ã¦ã¿ã¾ã—ãŸã€‚

ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã‚„åºƒå‘Šåˆ†é‡ã®çµŒé¨“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚  
ãã®ãŸã‚ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°çš„ãªè¦³ç‚¹ã‚„æŒ‡æ¨™ã®æ‰ãˆæ–¹ãŒæœ¬è·ã®æ–¹ã¨ã¯ç•°ãªã‚‹éƒ¨åˆ†ã‚‚ã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã€ŒAWSã‚µãƒ¼ãƒ“ã‚¹ã‚’çµ„ã¿åˆã‚ã›ã¦ãƒãƒƒãƒå‡¦ç†ã‚’è‡ªå‹•åŒ–ã™ã‚‹ã€ã¨ã„ã†æŠ€è¡“çš„ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ä¸»çœ¼ã«ç½®ã„ã¦ã„ã¾ã™ã€‚

---

## ğŸ“‹ è¦ä»¶ãƒ»åˆ¶ç´„

å˜ç´”ã«ã“ã®æ§‹æˆã§ã‚„ã£ã¦ã¿ãŸã‹ã£ãŸã ã‘ã§ã™

### æŠ€è¡“è¦ä»¶
 - åºƒå‘Šã®ã‚¯ãƒªãƒƒã‚¯ãƒ­ã‚°ã‚’Redisã«è“„ç©
 - Lambdaæ—¥æ¬¡ãƒãƒƒãƒã§ãƒ­ã‚°ã‚’é›†è¨ˆã—ã¦Postgreã«è“„ç©
 - Redisã®ãƒ‡ãƒ¼ã‚¿ã¯æ—¥æ¬¡ãƒãƒƒãƒå®Œäº†æ™‚ã«å‰Šé™¤

### åˆ¶ç´„æ¡ä»¶
 - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ—©ãâ†’æœ¬ä½“ã‹ã‚‰åˆ‡ã‚Šé›¢ã—ã¦API Gateway + Redisã§é›†è¨ˆ
 - ç®¡ç†ç”»é¢ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚‚è½ã¨ã—ãŸããªã„â†’å¤œé–“æ—¥æ¬¡ãƒãƒƒãƒã§é›†ç©ã—ã¦Postgreã«ç™»éŒ²

---

## ï¿½ï¿½ï¸ è¨­è¨ˆæ–¹é‡ãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```txt
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web App       â”‚    â”‚    Redis     â”‚    â”‚   PostgreSQL    â”‚
â”‚   (Rails)       â”‚â”€â”€â”€â–¶â”‚   (Cache)    â”‚â”€â”€â”€â–¶â”‚   (Analytics)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   Lambda     â”‚
                       â”‚   (Python)   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

1. **API Gateway**: ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’Redisãƒãƒƒã‚·ãƒ¥ã«è¨˜éŒ²
2. **Redis**: æ—¥æ¬¡ã‚­ãƒ¼ï¼ˆ`clicklog_keys:YYYYMMDD`ï¼‰ã§ãƒãƒƒã‚·ãƒ¥å½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ä¿å­˜
3. **Lambda**: æ—¥æ¬¡ãƒãƒƒãƒã§Redisã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»é›†è¨ˆ
4. **PostgreSQL**: é›†è¨ˆçµæœã‚’`advertisement_analytics`ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜

### æŠ€è¡“é¸å®šç†ç”±

- **Redis**: é«˜é€Ÿãªã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªå‡¦ç†ã¨ãƒãƒƒã‚·ãƒ¥å½¢å¼ã§ã®åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿ç®¡ç†
- **Lambda**: ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã§ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªãƒãƒƒãƒå‡¦ç†
- **Python**: å€‹äººã®å¥½ã¿

---

## ğŸ”§ å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆãƒ»å·¥å¤«

### 1. Redisãƒãƒƒã‚·ãƒ¥å½¢å¼ã§ã®ãƒ‡ãƒ¼ã‚¿ç®¡ç†

```python
# åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ 
key = f"clicklog_keys:{target_date}"
r.hincrby(key, f"{ad_id}:{search_word}", 1)
```

 - åºƒå‘Šã«ã¯è¤‡æ•°ã®ã‚¿ã‚°ãŒç´ã¥ã„ã¦ãŠã‚Šã€ã€Œã©ã®ã‚¿ã‚°ã§è¡¨ç¤ºã•ã‚Œã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‹ã€ã®æƒ…å ±ãŒå¿…è¦  
->ã‚¿ã‚°ã”ã¨ã®åºƒå‘ŠåŠ¹æœæ¸¬å®šãŒå¯èƒ½
 - é›†è¨ˆã—ã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ã®èª¤å‰Šé™¤ã‚’é˜²ããŸã‚ã«æ—¥ä»˜ã‚’æŒãŸã›ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ—¥ä»˜ã‚’å–å¾—ã™ã‚‹å½¢ã«å®Ÿè£…  
 ->æ—¥ä»˜å¤‰æ›´é–“éš›ã§å¤‰ãªå‹•ãã‚’ã•ã›ãªã„

### 2. ãƒãƒƒãƒå‡¦ç†ã§ã®åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿å–å¾—

```python
# ãƒãƒƒã‚·ãƒ¥å…¨ä½“ã‚’ä¸€åº¦ã«å–å¾—
log_data = r.hgetall(key_set_name)

# ãƒãƒƒãƒæŒ¿å…¥ã§PostgreSQLã«ä¿å­˜
execute_values(cursor, insert_query, insert_data)
```

### 3. Docker Composeã§ã®ç’°å¢ƒçµ±ä¸€

```yaml
  batch:
    build: ./containers/batch
    depends_on:
      - redis
      - db
    environment:
      REDIS_HOST: redis
      REDIS_PORT: ${REDIS_PORT}
      POSTGRES_HOST: db
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./containers/batch:/app
```

### 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

```python
try:
    execute_values(cursor, insert_query, insert_data)
    conn.commit()
except Exception as e:
    conn.rollback()
    print(f"âŒ PostgreSQLç™»éŒ²ã‚¨ãƒ©ãƒ¼: {e}")
```

ã“ã‚Œprintã£ã¦CloudWatchã¨ã‹ã«å‡ºã‚“ã®ã‹ã‚„ï¼Ÿ

---

## ğŸ’¬ ä»Šå¾Œã®å±•æœ›ãƒ»èª²é¡Œ

 - Redisã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã™ã‚‹ã¨ã“ã‚ã®ä½œæˆ
 - Lambdaã¸ã®ä¹—ã›æ›ãˆ

---

## ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯ãƒ»è³‡æ–™

- [å½“è©²PR](https://github.com/perpouh/AdControlHub/pull/9)
- [Rediså…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://redis.io/docs/latest/)

### å‚è€ƒè¨˜äº‹

- [Pythonã§Redisã‚’æ“ä½œã—ã‚ˆã† (åŸºæœ¬æ“ä½œç·¨) | WEB ARCH LABO](https://weblabo.oscasierra.net/python/python-redis-py-1.html)